<html>
<body>
<b>Secure Attributes Exchange (SAE) : Sample </b>
<br><br>
This sample demonstrates usage of SAE feature.
<br>
<br> <b>Actors :</b>
<br> (1) FAM-IDP : FAM setup as samlv2 IDP.
<br> (2) FAM-SP : FAM setup as samlv2 SP.
<br> (3) samplesaml2cot : Circle of Trust comprising FAM-IDP and FAM-SP.
<br> (4) IDP-App : A web application hosted on IDP end (saeIDPApp.jsp). 
<br> (5) SP-App : A web application hosted on SP end (saeSPApp.jsp).
<br>
<br>
<br><a><b>IDP-App</b> --- sae --- <b>FAM-IDP</b> -|- samlv2 -|- <b>FAM-SP</b> --- sae --- <b>SP-App</b></a>
<br>
<br> The detailed steps listed below will  help you learn the following aspects of SAE:
<br>  - Setting up trust relationship between IDP-App and FAM-IDP.
<br>  - Setting up trust relationship between SP-App and FAM-SP.
<br>  - Passing user Authentication information from IDP-App to FAM-IDP.
<br>  - Passing user attribute information from IDP-App to FAM-IDP.
<br>  - Using FAM-IDP as a gateway to access SP-App.
<br>  - Consuming authentication and attribute data in SP-App.
<br>
<br><b>Detailed Steps</b>
<br> <i>Step 1 </i>: Perform initial install & setup as in SAMLv2 <a href="../index.html">sample main page</a> <b>Setup</b> section.
              In effect we are creating two domains that will communicate
              over SAMLv2.
<br>
<br> <i>Step 2</i> : Establish trust between IDP-App and IDP-FAM.
<br><b>Symmetric Method :</b> Choose a shared secret to be used between IDP-App and FAM-IDP. 
<br>(2a) saeIDPApp.jsp is factored as a form that will prompt for these values, but you may choose to edit it to : (i) initialize <i>cryptotype</i> variable to "symmetric" (ii) initialize the <i>secret</i> variable to shared secret string.[ Note - in a real deployment the app should store this secret on disk by encrypting it in a file and keeping the file safe. ] and (ii) initialize the <i>idpAppName</i> variable to a string that uniquely identifies this IDP-App  (iii) initialize the <i>saeServiceUrl</i> parameter to : &lt;FAM-IDP deployment url&gt;/idpsaehandler
<br>(2b) Export FAM-IDP's metadata; Edit idpExtended Metadata file to add the following information : IDP-App name, type and shared secret; Re-load metadata on IDP end.
<br>(2c) Export FAM-SP's metadata on FAM-IDP end; Edit spExtended metadata file to add the following information: saml attributes to be sent as part of the saml assertion to FAM-SP, and FAM-SP SAE handling url; Re-load FAM-SP's metadata on FAM-IDP end. Restart web container if needed.
<br><b>Asymmetric Method :</b>Obtain a private-public key pair. Store the key pair ia secure keystore. Add the publickey to FAM-SP's keystore (see saml2 docs).
<br>(2a)saeIDPApp.jsp is factored as a form that will prompt for these values, but you may choose to edit it to : (i) initialize <i>cryptotype</i> variable to "asymmetric" (ii) initialize the <i>secret</i> variable to private key alias string.[ Note - in a real deployment the app should store private key in a secure keystor. ] and (ii) initialize the <i>idpAppName</i> variable to a string that uniquely identifies this IDP-App  (iii) initialize the <i>saeServiceUrl</i> parameter to : &lt;FAM-IDP deployment url&gt;/idpsaehandler
<br>(2b) Export FAM-IDP's metadata. Return to SAMLv2 sample steps: edit idpExtended Metadata file to add the following information : IDP-App name, encryption type and pubkeyalias; Re-load FAM-IDP metadata on IDP end.
<br>(2c) Export FAM-SP's metadata on FAM-IDP end; Edit spExtended metadata file to add the following information: saml attributes to be sent as part of the saml assertion to FAM-SP, and FAM-SP SAE handling url; Re-load FAM-SP's metadata on FAM-IDP end. Restart web container if needed.

<br><br> <i>Step 3</i> : Establish trust between SP-App and FAM-SP.
<br><b>Symmetric Method:</b> Choose a shared secret to be used between SP-App and FAM-SP. 
<br>(3a) Edit saeSPApp.jsp to :(i) initialize <i>cryptotype</i> variable to "symmetric" (ii) initialize the <i>secret</i> variable to the shared secret string.[ Note - in a real deployment the app should store this secret on disk by encrypting it in a file and keeping the file safe. ]. (iii) determine the URL representing this SP-App.
<br>(3b) Export FAM-SP's metadata on FAM-SP end; Edit spExtended Metadata file to add the following information : SP-App URL, encryption type, shared secret, auto-federation, saml attributes to be sent as part of the saml assertion, and SAE logout url if needed; Re-load metadata on SP. Restart web container if needed.
<br><b>Asymmetric Method:</b> Obtain a private-public key pair for setting up FAM-SP.
<br>(3a) Setup the public/private key in a local keystore.
<br>(3b) Edit saeSPApp.jsp to :(i) initialize <i>cryptotype</i> variable to "asymmetric" (ii) initialize the <i>secret</i> variable to the FAM's public key alias string.
 (iii) determine the URL representing this SP-App. (iv) Setup rest of init params.
<br>(3c) Export FAM-SP's metadata on FAM-SP end; Edit spExtended metadata file to add the following information: SP-App URL, encryption type, pubkeyalias, auto-federation, saml attributes to be sent as part of the saml assertion, and SAE logout url if needed; Re-load FAM-SP metadata on SP end. Restart web container if needed.
<br>
<br> <i>Step 4</i> : Deploy saeAppIDP.jsp and saeAppSP.jsp on the respective domains. For simplicity you may choose to use the predeployed jsps on respective FAM instances. But it is recommended you install them in their own web containers. 
<br>
<br> <i>Step 5</i> : Execute the sample.
<br>  Start a browser and access <IDP-App deployment url>/saeIDPApp.jsp
<br>  Fill up the form with the values you want communicated to FAM-IDP :
<br>    logged in username, attributes (mail, branch).
<br>  Clicking on "Send Attributes" will securely invoke SP-App.
<br>
<br> <b>Troubleshooting</b>
<br> FAM Debug files : SAE and samlv2 on IDP and SP ends.
<br> dumpcookies.jsp can be deployed on SP/IDP ends to view http headers and FAM session.
<br> --
</body>
</html>
